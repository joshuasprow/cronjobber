{{ template "layout" }}
{{ define "pages/logs" }}
  <!doctype html>
  <html>
    <head>
      {{ block "meta" . }}{{ end }}
      <title>
        {{ block "title" . }}cronjobber - logs{{ end }}
      </title>
      {{ block "css" . }}{{ end }}
      <style>
        h1 {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0 0.5rem;

          label {
            display: flex;
            align-items: center;
            font-size: 1rem;
            margin-left: auto;
          }
        }

        ul {
          max-height: 400px;
          overflow: auto;
          padding: 0 0.5rem 16px /* scrollbar */ 0.5rem;
        }

        li {
          list-style: none;
        }
      </style>
      {{ block "js" . }}{{ end }}
      <script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/sse.js"></script>
    </head>
    <body>
      <main
        hx-get="/logs"
        hx-include="#container-inputs"
        hx-target="#logs"
        hx-trigger="load"
      >
        <h1>
          <span>{{ .Pod }}</span>
          <label>
            <input id="follow" name="follow" type="checkbox" checked />
            follow
          </label>
        </h1>
        {{ template "components/containerinputs" . }}
        <ul
          id="logs"
          hx-ext="sse"
          hx-swap="beforeend"
          sse-connect="/logs?namespace={{ .Namespace }}&pod={{ .Pod }}&name={{ .Name }}"
          sse-swap="log"
          style="scroll-behavior:smooth;"
        >
          {{ template "components/logs" . }}
        </ul>
      </main>

      <script>
        // @ts-check
        document.addEventListener("DOMContentLoaded", () => {
          const els = getElements();

          if (!els) {
            return;
          }

          els.follow.addEventListener("change", onFollowChange);

          attachLogsListeners(els);
        });

        /** @param {Event} [followChangeEvent] */
        function getElements(followChangeEvent) {
          let follow;

          if (followChangeEvent) {
            follow = followChangeEvent.target;
          } else {
            follow = document.getElementById("follow");
          }

          const logs = document.getElementById("logs");

          if (!follow || !(follow instanceof HTMLInputElement)) {
            console.error("missing or invalid follow checkbox element", follow);
            return;
          }

          if (!logs || !(logs instanceof HTMLElement)) {
            console.error("missing or invalid logs list element", logs);
            return;
          }

          return { follow, logs };
        }

        /**
         * @param {CustomEvent<{ elt: HTMLElement }>} event
         * [htmx.org](https://htmx.org/events/#details-3)
         */
        function onAfterLogsListSettle(event) {
          const logsList = event.detail.elt;
          logsList.scrollTop = logsList.scrollHeight;
        }

        /** @param { { logs: HTMLElement; follow: HTMLInputElement } } els */
        function attachLogsListeners(els) {
          if (els.follow.checked) {
            els.logs.addEventListener(
              "htmx:afterSettle",
              onAfterLogsListSettle,
            );

            els.logs.scrollTop = els.logs.scrollHeight;

            return;
          }

          els.logs.removeEventListener(
            "htmx:afterSettle",
            onAfterLogsListSettle,
          );
        }

        /** @param {Event} event */
        function onFollowChange(event) {
          const els = getElements(event);

          if (!els) {
            return;
          }

          attachLogsListeners(els);
        }
      </script>
    </body>
  </html>
{{ end }}
